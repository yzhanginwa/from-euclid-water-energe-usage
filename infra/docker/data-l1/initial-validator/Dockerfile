ARG TESSELLATION_VERSION

FROM --platform=linux/amd64 metagraph-base-image-${TESSELLATION_VERSION}

ARG GIT_PERSONAL_ACCESS_TOKEN
ARG P12_FILE_NAME_GENESIS
ARG P12_FILE_KEY_ALIAS_GENESIS
ARG P12_FILE_PASSWORD_GENESIS
ARG TEMPLATE_NAME

ENV LC_ALL C.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8

ENV GITHUB_TOKEN=${GIT_PERSONAL_ACCESS_TOKEN}
ENV CL_KEYSTORE=${P12_FILE_NAME_GENESIS}
ENV CL_KEYALIAS=${P12_FILE_KEY_ALIAS_GENESIS}
ENV CL_PASSWORD=${P12_FILE_PASSWORD_GENESIS}

COPY project/$TEMPLATE_NAME codebase/$TEMPLATE_NAME
COPY p12-files/${P12_FILE_NAME_GENESIS} ${P12_FILE_NAME_GENESIS}

RUN rm -r -f codebase/$TEMPLATE_NAME/modules/data_l1/target

RUN cd codebase/$TEMPLATE_NAME && \
    sbt dataL1/assembly

RUN mv codebase/$TEMPLATE_NAME/modules/data_l1/target/scala-2.13/*.jar data-l1.jar